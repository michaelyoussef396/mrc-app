// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from '@/types/database.types';

const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;
const SUPABASE_PUBLISHABLE_KEY = import.meta.env.VITE_SUPABASE_ANON_KEY;

// Validate environment variables at runtime
if (!SUPABASE_URL || !SUPABASE_PUBLISHABLE_KEY) {
  throw new Error(
    'Missing Supabase environment variables. Please ensure VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY are set in .env.local'
  );
}

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
  auth: {
    // CRITICAL: Enable session persistence across page reloads
    persistSession: true,

    // CRITICAL: Use localStorage for persistence across tabs
    storage: window.localStorage,

    // CRITICAL: Auto-refresh tokens before they expire
    autoRefreshToken: true,

    // CRITICAL: Detect session from URL (for password reset links)
    detectSessionInUrl: true,

    // CRITICAL: Use implicit flow for password recovery
    // PKCE converts ?token_hash= to ?code= which creates regular session, not recovery session
    // Password updates require recovery session (403 error with regular session)
    flowType: 'implicit',

    // Debug mode (only in development)
    debug: import.meta.env.DEV,
  },

  // Global options
  global: {
    headers: {
      'x-application-name': 'mrc-lead-management',
    },
  },
});

// Log session state changes in development (helpful for debugging password reset issues)
if (import.meta.env.DEV) {
  supabase.auth.onAuthStateChange((event, session) => {
    console.log('üîê [Supabase Client] Auth State Change:', event);
    console.log('üìù [Supabase Client] Session:', session ? 'Active' : 'None');
    if (session) {
      console.log('üë§ [Supabase Client] User:', session.user.email);
      console.log('‚è∞ [Supabase Client] Expires:', new Date(session.expires_at! * 1000).toLocaleString());
    }
  });
}